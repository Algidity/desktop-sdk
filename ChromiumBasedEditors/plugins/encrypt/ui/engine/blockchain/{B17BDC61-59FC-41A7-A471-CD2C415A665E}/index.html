<!DOCTYPE html>
<html lang="en">
    <head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
		<title>onlypass</title> 
		<link rel="stylesheet" type="text/css" href="./css/style.css" />
		<script type="text/javascript" src="./js/third-party/web3.min.js"></script>
		<script type="text/javascript" src="./js/third-party/jquery-3.3.1.min.js"></script>
		<script type="text/javascript" src="./js/third-party/jquery.blockUI.js"></script>
		<script type="text/javascript" src="./js/third-party/lightwallet.min.js"></script>
		<script type="text/javascript" src="./js/third-party/nacl.min.js"></script>
		<script type="text/javascript" src="./js/third-party/nacl-util.min.js"></script>
		<script type="text/javascript" src="./js/third-party/sealedbox.web.js"></script> 				
		<script type="text/javascript" src="./js/third-party/clipboard.min.js"></script> 
		<script type="text/javascript" src="./js/onlyonet.js"></script>
		<script type="text/javascript" src="./js/onlyonet.config.js"></script>
		<script type="text/javascript" src="code.js"></script>
		
		<script type="text/javascript">
				$(function() {
					$("#box-blockchain-connect a.text-sub").click(function(){
						initSwitchOnDialog();
						$("#dlg-onoffswitch")[0].showModal();
					});

					$("#box-connect-to-cloud a.link").click(function() {
						parent.postMessage(window.JSON.stringify({type:'plugin', data:{command:'panel:select', params:'connect'}}), "*");
					});
 
					$("#enc-mode-switch").click(function () {						
						if($(this).is(":checked")) {
							initSwitchOnDialog();
							$("#dlg-onoffswitch")[0].showModal();

							return false;
						}
						else {

							const ASC_DESKTOP_EDITOR_DEFAULT_MODE = 0;

							AscDesktopEditor.SetCryptoMode("", ASC_DESKTOP_EDITOR_DEFAULT_MODE, function(retCode) {
								switch (retCode)
								{
									case 0: // OK
									{
										$("#box-blockchain-connect").show();
										$("#box-blockchain-info").hide();

										break;
									}
									case 1: 
									{

										break;
									}
									default: 
									{

										break;
									}

								}
							});

						}	
					});  

					$("#box-blockchain-connect button.primary").click(function () {
						initVaultDialog();

						$("#dlg-vault div.title label.caption").text("Create your Account with Seed Phrase");
						$("#dlg-vault textarea").removeAttr("placeholder");
						$("#dlg-vault button.btn.primary").text("I've copied my mnemonice to a safe place");
						$("#dlg-vault textarea").val(ONLYONET.generateRandomSeed());
														
						$("#dlg-vault")[0].showModal();						
					});				

					$("#dlg-onoffswitch button.primary").click(function () {
						$("#dlg-onoffswitch button.primary").attr("disabled","disabled");
						$("#dlg-onoffswitch img.img-loader").show();
						
						let pwd = $("#dlg-onoffswitch input:password").val();												
						

						ONLYONET.readSeedPhraseFromFile(pwd, function(seedPhrase) {
						
							if (!ONLYONET.isSeedPhraseValid(seedPhrase)) {
								$("#dlg-onoffswitch .error-box p").show();
								$("#dlg-onoffswitch input:text").addClass("error");

								$("#dlg-onoffswitch button.primary").removeAttr("disabled");
								$("#dlg-onoffswitch img.img-loader").hide();
														
								return false;							
							}							
							
							var cnf = jQuery.extend(true, {}, ONLYONET.defaultConfig);					

							cnf.seedPhrase = seedPhrase;
							cnf.password = pwd;

							blockchainSwitchOn(cnf, "#dlg-onoffswitch .tool.close");
						});

					});	
			
					$("#dlg-onoffswitch a.text-sub").click(function () {
						$("#dlg-onoffswitch .tool.close").trigger("click");	

						initVaultDialog();

						$("#dlg-vault div.title label.caption").text("Restore your Account with Seed Phrase");
						$("#dlg-vault textarea").attr("placeholder", "Enter your secret twelve word phrase here to restore your account");
						$("#dlg-vault button.btn.primary").text("Restore");					
					
						$("#dlg-vault")[0].showModal();				
					});

					$("#dlg-vault .tool.close").click(function(){						
						$("#dlg-vault")[0].close();					
					});
					
					$("#dlg-vault a.text-sub").click(function () {
						$("#dlg-vault .tool.close").trigger("click");
					});
					
					$(document).keydown(function(event) {					
						if (event.which == 13 ) { // enter
							if ($("#dlg-onoffswitch").prop("open")) {
								$("#dlg-onoffswitch button.primary").trigger("click");	
							}
 
//						if ($("#dlg-vault").prop("open")) {
//								$("#dlg-vault button.primary").trigger("click");	
//							}
						}
					});

					$("#dlg-vault button.primary").click(function() {
						$("#dlg-vault img.img-loader").show();
						$("#dlg-vault button.primary").attr("disabled", "disabled");

						let pwd = $("#dlg-vault input:password:first").val();	
						let pwdRepeat = $("#dlg-vault input:password:eq(1)").val();	
					
						if ((pwd !== pwdRepeat) || (pwd.length < ONLYONET.defaultConfig.passwordLength))
						{
							if (pwd !== pwdRepeat) {
								$("#dlg-vault .error-box:eq(1) p.msg-error").text("Don't Match");
								$("#dlg-vault .error-box:eq(2) p.msg-error").text("Don't Match");
							}
						
							if (pwd.length < ONLYONET.defaultConfig.passwordLength) {
								$("#dlg-vault .error-box:eq(1) p.msg-error").text("Password not long enough");
								$("#dlg-vault .error-box:eq(2) p.msg-error").text("Password not long enough");							
							}													

							$("#dlg-vault input:password:first").addClass("error");
							$("#dlg-vault input:password:eq(1)").addClass("error");
						
							$("#dlg-vault .error-box:eq(1) p.msg-error").show();
							$("#dlg-vault .error-box:eq(2) p.msg-error").show();

							$("#dlg-vault img.img-loader").hide();
						    $("#dlg-vault button.primary").removeAttr("disabled");
							
							return false;
						}

						$("#dlg-vault .error-box:eq(1) p.msg-error").hide();
						$("#dlg-vault .error-box:eq(2) p.msg-error").hide();

						let seedPhrase = $("#dlg-vault textarea").val();
						
						if (!ONLYONET.isSeedPhraseValid(seedPhrase)) {
							$("#dlg-vault .error-box:first p").show();
							$("#dlg-vault textarea").addClass("error");
						
							$("#dlg-vault img.img-loader").hide();
							$("#dlg-vault button.primary").removeAttr("disabled");

							return false;							
						}

						$("#dlg-vault .error-box:first p").hide();
						
						ONLYONET.storeSeedPhraseToFile(seedPhrase, pwd, function(written_data) {
							if (seedPhrase != written_data) // error
							{
								$("#dlg-vault img.img-loader").hide();
								$("#dlg-vault button.primary").removeAttr("disabled");
		
								return false;
							}
							else // OK 
							{								
								let cnf = jQuery.extend(true, {}, ONLYONET.defaultConfig);					

								cnf.seedPhrase = seedPhrase;
								cnf.password = pwd;							

								blockchainSwitchOn(cnf, "#dlg-vault .tool.close");
							}
						});
					});

					$("#dlg-onoffswitch .tool.close").click(function() {
						$("#dlg-onoffswitch")[0].close();
					});

					$("#dlg-private-key .tool.close").click(function () {
						$("#dlg-private-key")[0].close();
					});

					$("#dlg-private-key button.primary").click(function () {
						$("#dlg-private-key .tool.close").trigger("click");
					});

					$("#tbl-acount-info tfoot a").click(function() {
						let privateKey = ONLYONET.getPrivateKey();
						
						$("#dlg-private-key div.body button.primary").attr("data-clipboard-text",privateKey);
						$("#dlg-private-key div.body span").text(privateKey);

						let clip = new ClipboardJS('#dlg-private-key div.body button.primary');

						clip.on('success', function(e) {		
								e.clearSelection();
							  });

						$("#dlg-private-key")[0].showModal();												
					});
				});			
				
				function initVaultDialog() {
					$("#dlg-vault img.img-loader").hide();
					$("#dlg-vault .error-box:last p").hide();
					$("#dlg-vault textarea").removeClass("error");
					$("#dlg-vault textarea").val("");
					$("#dlg-vault input:password:first").val("");
					$("#dlg-vault input:password:eq(1)").val("");
					$("#dlg-vault input:password:first").removeClass("error");
					$("#dlg-vault input:password:eq(1)").removeClass("error");
					$("#dlg-vault .error-box:eq(1) p.msg-error").hide();
					$("#dlg-vault .error-box:eq(2) p.msg-error").hide();
					$("#dlg-vault button.primary").removeAttr("disabled");
				}

				function initSwitchOnDialog() {
					$("#dlg-onoffswitch .error-box p").hide();
					$("#dlg-onoffswitch img.img-loader").hide();
					$("#dlg-onoffswitch input:password").val("");	
					$("#dlg-onoffswitch input:text").removeClass("error");	
					$("#dlg-onoffswitch button.primary").removeAttr("disabled");					
				}

				function blockchainSwitchOn(cnf, dlgButtonClose) { 	
					
					const ASC_DESKTOP_EDITOR_CRYPTO_MODE = 3;
					
					AscDesktopEditor.SetCryptoMode("", ASC_DESKTOP_EDITOR_CRYPTO_MODE, function(retCode) {
						switch (retCode)
						{
							case 0: // OK
							{
								$("div.info-box.excl").hide();						
							
								ONLYONET.init(cnf).then(function(isConnected) {	

									renderBlockChainInfo();
									
									$("#enc-mode-switch").prop("checked", true);
									$("#box-blockchain-connect").hide();
									$("#box-blockchain-info").show();

									$(dlgButtonClose).trigger("click");									

									let address = ONLYONET.getAddress();
									
									requestEtherFromFaucet(address);						
								});

							break;
						}
						case 1:
						{
							$(dlgButtonClose).trigger("click");
							$("div.info-box.excl").show();
							
							break;
						}
						default:
							break;
						}					
					});
				}

				function renderBlockChainInfo() {					

					let address = ONLYONET.getAddress();

					$("#tbl-acount-info tbody td:eq(0) span").text(address);	
					$("#box-network-info dd:eq(0)").text(ONLYONET.getNetworkId());
					$("#box-network-info dd:eq(1)").text(ONLYONET.getBlockNumber());
					$("#tbl-acount-info tbody td:eq(2)").text(ONLYONET.getTransactionCount());	

					$("#box-network-info dd:eq(2)").text(ONLYONET.getAvarageGasPriceBlock().toString());
					$("#box-network-info dd:eq(3)").text(ONLYONET.getBlockGasLimit());

					$("#tbl-acount-info tbody td:eq(1)").text(ONLYONET.getBalance("ether") + " ETH");
					$("#box-network-selector span:eq(1)").text(ONLYONET.getProviderUri());

					$("#tbl-acount-info tbody td:eq(0) a").attr("data-clipboard-text",address);

					let clip = new ClipboardJS($("#tbl-acount-info tbody td:eq(0) a")[0]);

					clip.on('success', function(e) {							
						e.clearSelection();
					});
				}

				function requestEtherFromFaucet(address) {
					let balance = ONLYONET.getBalance("ether");			

					if (balance >= 5) return;
						
					let signMsg = ONLYONET.sign(address);	
					
					$.ajax({						
						url: ONLYONET.getProviderUri() + "/faucet",
						contentType:"application/json; charset=utf-8",
						method: 'POST',
						async: true,
						data: JSON.stringify({
									   "address":address,
									   "signature": signMsg
								   })
					}).done(function() {
						let balance  = ONLYONET.getBalance("ether");

						$("#tbl-acount-info tbody td:eq(1)").text(balance + " ETH");
					}).fail(function() {

					});
				}
		</script>
	  </head>
      <body>	
		   <div class="info-box excl" style="display: none;">
			<div>
			  <strong>The Blockchain Mode in OFF.</strong> To switch it on, you must close all active edition sessions.
			</div>
		   </div>
			<section id="enc-box-caption">
					<h3 class="table-caption">Blockchain Mode (BETA)</h3>
					<div class="onoffswitch">
						<input type="checkbox" name="onoffswitch" class="onoffswitch__checkbox" id="enc-mode-switch"/>
						<label class="onoffswitch__label" for="enc-mode-switch"></label>
					</div>
			</section>	
			<section id="box-blockchain-connect">	
				<h4>Document encryption</h4>
				<p>
					Protect your DOCX, XLSX and PPTX files with asymmetric encryption powered by blockchain technology to secure store, 
					edit and co-edit them.
				</p>
				<p>			
					<a class="link-gray" target="popup" href="javascript:void(0)">Learn more about user Blockchain Mode</a> <a class="link-gray" target="popup" href="https://github.com/ONLYOFFICE/core-ext/tree/master/desktop-sdk-wrapper/additional/encrypted_ui">GitHub</a>
				</p>			
				<p>
					<button class="btn primary">Create an account in ONLYOFFICE blockchain</button> <a class="text-sub link" href="javascript:void(0)">I already have an account</a>
				</p>
			</section>
		<section id="box-blockchain-info" style="display: none">
			<h4>Account</h4>
			<div id="box-network-selector">
				<span>Test Network</span><br/>
				<span>-</span>
			</div>
			<hr />
			<table id="tbl-acount-info">
				<thead>
					<tr>
						<th>Address</th>
						<th>Balance</th>
						<th>TX Count</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><span>-</span> <a href="javascript:void(0)" class="link-gray">Copy Address</a></td>
						<td>-</td>
						<td>-</td>
					</tr>
				</tbody>
				<tfoot>
					<tr>
						<td colspan="3"><a href="javascript:void(0)" class="link-gray">Export private key</a></td>
					</tr>
				</tfoot>
			</table>
			<hr />
			<dl id="box-network-info">
				<dt>Network ID</dt>
				<dd>-</dd>
				<dt>Current Block</dt>
				<dd>-</dd>
				<dt>GAS Price</dt>
				<dd>-</dd>
				<dt>Gas Limit</dt>
				<dd>-</dd>
			</dl>
		</section>
		<section id="box-connect-to-cloud">
				<h4>Encrypted co-edition</h4>			
				<p>
					Log in to your ONLYOFFICE cloud, or register a new account to gain access to encrypted co-edition features. 
					To access co-edition in the encrypted mode, each user must log in to your ONLYOFFICE cloud and turn the Blockchain Mode on.
				</p>
				<p>
					<a class="link" href="javascript:void(0)">Log in or register in ONLYOFFICE cloud</a> 
				</p>
		</section>
		<dialog id="dlg-onoffswitch" class="dlg scaled" style="width: 500px;">
				<div class="title">
				  <label class="caption">Blockchain Mode on</label>
				  <span class="tool close img-el"></span>
				</div>
				<div class="body">
					<section>
						<div>
							<div class="error-box"><p class="msg-error" style="display: none;">Check the password</p></div>															
							<input type="password" name="" class="tbox" value="" placeholder="enter password" />							
							<div style="height:10px;"></div>
							<div  class="lr-flex">
								<a class="text-sub link" href="javascript:void(0)">Restore from seed phrase</a>
								<span></span>
								<div>
									<img class="img-loader">
									<button class="btn primary">Turn the Blockchain Mode on</button>
								</div>
							</div>
						</div>
					</section>
				</div>
		</dialog>	
		<dialog id="dlg-vault" class="dlg scaled" style="width: 500px;">
			<div class="title">
			  <label class="caption">Create Vault</label>
			  <span class="tool close img-el"></span>
			</div>
			<div class="body">
				<section>
					<div>							
						<div class="lr-flex">					
							<label>Wallet Seed Phrase</label> 
							<div class="error-box"><p class="msg-error" style="display: none;">Seed phrases are 12 words long</p></div>	
						</div>
						<textarea rows="2000" class="tbox"></textarea>	

						<div class="lr-flex">					
								<label>New Password (min 8 chars)</label> 
								<div class="error-box"><p class="msg-error" style="display: none;">Don't Match</p></div>	
						</div>
						<input type="password" class="tbox" value="111111aa" />					

						<div class="lr-flex">					
								<label>Confirm Password</label> 
								<div class="error-box"><p class="msg-error" style="display: none;">Don't Match</p></div>	
						</div>
						<input type="password" class="tbox" value="111111aa"  />	
						<div class="error-box">
							<p class="msg-error" style="display: block;">
								WARNING: Never disclose your backup phrase. Files encrypted with that seed phrase connot be accessed with any other credentials
							</p>
						</div>
						<div style="height:10px;"></div>
						<div class="lr-flex">
							<a class="text-sub link" href="javascript:void(0)">Cancel</a>
							<span></span>
							<div>
								<img class="img-loader">
								<button class="btn primary">I've copied my seed phrase to a safe place</button>
							</div>
						</div>
					</div>
				</section>
			</div>
		</dialog>	
		<dialog id="dlg-private-key" class="dlg scaled" style="width: 550px">
			<div class="title">
				<label class="caption">Your private key</label>
				<span class="tool close img-el"></span>
			</div>
			<div class="body">
				<section>
					<div>	
						<p>
							<span>-</span>	
						</p>
						<button class="btn primary">Copy to clipboard</button>
					</div>
				</section>
			</div>
		</dialog>
	</body>
</html>